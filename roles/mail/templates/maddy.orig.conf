# login users via username only but keep mailboxes with hostname appended
$(hostname) = {{app_domain}}
$(primary_domain) = {{domain}}
$(local_domains) = $(primary_domain)

auth_map email_localpart
debug {% if debug %}on{% else %}off{% endif +%}

storage.imapsql local_mailboxes {
    driver sqlite3
    dsn mail.db
}

{% if "users" in services %}
auth.ldap lokal_ldap {
    urls ldap://ldap:{{ldap_port}}
    # Specify initial bind credentials. Not required ('bind off')
    # if DN template is used.
    bind plain "cn={{admin_username}},ou=people,{{ldap_domain}}" "{{admin_password}}"
    # Specify DN template to skip lookup.
    dn_template "cn={username},ou=people,{{ldap_domain}}"
    starttls off
    debug {% if debug %}on{% else %}off{% endif %}
    connect_timeout 10s
}
{% else %}
auth.pass_table local_authdb {
    table file /data/users
}
{% endif %}

# do not suport startls/unecnrypted tcp://0.0.0.0:143 because it is impossible
# to route internally based on path. No internal (unsecured) use of IMAP allowed.
imap tls://0.0.0.0:993 {
{% if "users" in services %}
    auth &lokal_ldap
{% else %}
    auth &local_authdb
{% endif %}
    storage &local_mailboxes
}

# port 25 is for internal use only so services can communicate easily
# via docker's own network but it is not exposed to the internet
smtp tcp://0.0.0.0:25 {
    insecure_auth on
{% if "users" in services %}
    auth &lokal_ldap
{% else %}
    auth &local_authdb
{% endif %}
    modify {
        dkim {{domain}} lokal  # this means DNS TXT record to lokal._domainkey.{{domain}}
    }
    target.outbound_relay {
        mx_auth {}
    }
    destination {{domain}} {
        deliver_to &local_mailboxes
    }
    default_destination {
        deliver_to &outbound_relay
    }
}


submission tls://0.0.0.0:465 {
    limits {
        all rate 1 1m  # Max 1 msgs/min across any amount of SMTP connections.
    }
{% if "users" in services %}
    auth &lokal_ldap
{% else %}
    auth &local_authdb
{% endif %}

    source $(local_domains) {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            modify {
                dkim $(primary_domain) $(local_domains) default
            }
            deliver_to &remote_queue
        }
    }
    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}


msgpipeline local_routing {
    # Insert handling for special-purpose local domains here.
    # e.g.
    # destination lists.example.org {
    #     deliver_to lmtp tcp://127.0.0.1:8024
    # }

    destination postmaster $(local_domains) {
        modify {
            replace_rcpt &local_rewrites
        }

        deliver_to &local_mailboxes
    }

    default_destination {
        reject 550 5.1.1 "User doesn't exist"
    }
}

target.remote outbound_delivery {
    limits {
        # Up to 20 msgs/sec across max. 10 SMTP connections
        # for each recipient domain.
        all rate 1 1m  # Max 1 msgs/min across any amount of SMTP connections.
        destination concurrency 2
    }
    mx_auth {
        dane
        mtasts {
            cache fs
            fs_dir mtasts_cache/
        }
        local_policy {
            min_tls_level encrypted
            min_mx_level none
        }
    }
}

target.queue remote_queue {
    target &outbound_delivery

    autogenerated_msg_domain $(primary_domain)
    bounce {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}


submission tls://0.0.0.0:465 {
    hostname {{app_domain}}
    limits {
        # Up to 1 msgs/minute across max. 1 SMTP connection.
        all rate 1 1m
        all concurrency 1
    }
    read_timeout 10m
    write_timeout 1m
    max_message_size 32M
    max_header_size 1M
{% if "users" in services %}
    auth &lokal_ldap
{% else %}
    auth &local_authdb
{% endif %}
    defer_sender_reject yes
    dmarc yes
    smtp_max_line_length 4000
    modify {
        dkim {{domain}} lokal
    }
    check {
        spf
    }
    target.outbound_relay {
        mx_auth {}
    }
    destination {{domain}} {
        deliver_to &local_mailboxes
    }
    default_destination {
        deliver_to &outbound_relay
    }
}

tls file /etc/ssl/{{app_domain}}/{{app_domain}}.crt /etc/ssl/{{app_domain}}/{{app_domain}}.key {
    protocols tls1.2 tls1.3
}
