---
#
# Bootstrap script installs basic infracture for the lokal environment
# and its services. It comprises of databases, router, monitoring and mailing.
#
- name: Ensure base dirs exist"
  ansible.builtin.file:
    path: '{{item}}'
    state: directory
    owner: '{{ansible_facts["user_id"]}}'
  loop:
    - "{{backup_root}}"
    - "{{project_root}}"
  when: "not backup is defined and not restore is defined"

- name: Create app dirs
  ansible.builtin.file:
    path: '{{project_root}}/{{item}}'
    state: directory
  loop:
    - fail2ban/filter.d
    - fail2ban/jail.d
    - mysql
    - .certs
    - .dumper
    - postgres
    - traefik/acme
    - traefik/conf
    - traefik/data
    - traefik/log
    - traefik/dump
    - minio/data
    - minio/config
    - minio/config/policies

- name: Get certificates - key
  ansible.builtin.copy:
    src: "{{ssl_key}}"
    dest: "{{project_root}}/.certs/default.key"
  when: ssl_key is defined and ssl_cert is defined

- name: Get certificates - cert
  ansible.builtin.copy:
    src: "{{ssl_cert}}"
    dest: "{{project_root}}/.certs/default.crt"
  when: ssl_key is defined and ssl_cert is defined

# Maybe we don't need to do that. Docker manages the firewall itself and unless we expose a port
# to the host, we don't need to do anything. So don't expose ports. Use internal docker network.
# - name: Init IPTABLES firewall
#   ansible.builtin.import_role:
#     name: geerlingguy.firewall.d
#   vars:
#     firewall_state: started
#     firewall_enabled_at_boot: true
#     firewall_allowed_tcp_ports:
#       # ssh
#       - "{{ansible_port | default(22)}}"
#       # web
#       - 80
#       - 443
#       - 8448 # federation
#     firewall_disable_ufw: true
#     firewall_flush_filter_chains: ["INPUT"]
#     firewall_flush_rules_and_chains: false
#     firewall_restart_docker: true
#   become: true

- name: Find all certificates to print them into traefik dynamic.yml
  ansible.builtin.find:
    paths: "{{project_root}}/.certs/"
    recurse: true
    patterns: '*.crt'
  register: cert_find_output
  when: ssl_use_acme is falsy and not(ssl_key is defined and ssl_cert is defined)

- name: Debug certs
  debug:
    var: cert_find_output

- name: "Render traefik config"
  ansible.builtin.template:
    src: traefik/dynamic.yml
    dest: '{{project_root}}/traefik/conf/dynamic.yml'
    force: true

- name: "Copy prometheus config"
  ansible.builtin.copy:
    src: files/prometheus
    dest: '{{project_root}}/prometheus/etc/'

- name: "Copy dumper's hook"
  ansible.builtin.copy:
    src: files/dumper/hook.sh
    dest: '{{project_root}}/.dumper/hook.sh'

- name: Render traefik fail2ban filter
  ansible.builtin.template:
    src: fail2ban/traefik-filter.conf.j2
    dest: '{{project_root}}/fail2ban/filter.d/traefik-filter.conf'

- name: Render traefik fail2ban jail
  ansible.builtin.template:
    src: fail2ban/traefik-jail.conf.j2
    dest: '{{project_root}}/fail2ban/jail.d/traefik.conf'

- name: Render minio client config
  ansible.builtin.template:
    src: minio/config.json
    dest: '{{project_root}}/minio/config/config.json'

- name: Render base docker-compose.yml
  ansible.builtin.template:
    src: compose.yml
    dest: '{{project_root}}/docker-compose.yml'

- name: Docker-compose up
  ansible.builtin.shell:
    cmd: "docker compose up -d"
    chdir: "{{project_root}}"

- name: Give the base time to boot up - takes at least 10 seconds
  ansible.builtin.pause:
    seconds: 10
